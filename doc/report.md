# 22-23春《数据库原理》课程实验——设计文档

### 元数据模块

1. **数据库系统——`Manager`类**

数据库的相关信息——数据库名称由`Manager`类进行管理，存入`/data/manager_meta`文件（可读文本）中。该文件仅在：

- 创建新的数据库
- 删除已有数据库

时发生改变。系统重启恢复时，根据该文件中存储的数据库名称找到各数据库对应的元数据文件以恢复相关信息。而数据库内部信息——表名称、各表结构的管理则交由`Database`类进行。

2. **数据库——`Database`类**

数据库内部相关信息——数据库名称、表名称、表结构由`Database`类进行管理，存入`/data/<DatabaseName>/meta`文件（二进制文件）中。该文件仅在：

- 创建新的表
- 删除已有表

时发生改变。系统重启恢复时，根据该文件中存储的表相关信息恢复各表的管理类——`Table`类。

3. **数据表——`Table`类**

数据表相关信息——表名称、表结构、主键索引B+树、B+树节点缓存管理类 由`Table`类进行管理，存入`/data/<DatabaseName>/<TableName>/meta`文件（二进制文件）中。该文件仅在：

- 插入数据
- 删除数据
- 更新数据

时发生改变。`Table`类对数据的查询、变更均由其**B+树成员变量`index`以及`index`的成员变量`TreeNodeManager`——B+树节点缓存管理类**进行。系统重启恢复时，在恢复`Table`类的同时并恢复该数据表上的索引节点管理类`TreeNodeManager`，并**默认从相关文件中加载根节点至内存，并使其常驻内存**。

>这是由于任何操作都从根节点开始，对根节点的访问频率最高。

### 存储模块

1. **数据索引、持久化——`BPlusTree`与`TreeNodeManager`类**

在原有的B+树框架上进行改动，现由`TreeNodeManager`管理节点缓存空间，不再将整颗B+树加载至内存，而对B+树的操作均**以节点为单位**进行——任何对B+树上的操作需要从`TreeNodeManager`中申请节点对象。

B+索引树现对应一个`TreeNodeManager`，而`TreeNodeManager`使用固定大小——`GLOBAL.CACHE_SIZE`的哈希表，在内存中保留根节点以及最近加载、使用的节点。并且用`LinkedHashMap`，使用**LRU缓存管理策略，在缓存为满且由于缓存未命中而需要加载新的节点时将最近最少使用的节点从缓存中删除**。

而`TreeNodeManager`则是根据每个节点的唯一辨识符（`UUID`）对请求的节点进行识别，并找到相关文件以加载的。

>每个节点相应的数据文件路径：`/data/<DatabaseName>/<TableName>/<Node-ID>`

2. **INSERT**

从根节点开始，查询新的数据需要插入的位置，若子节点未在缓存中，则从磁盘中加载。

3. **DELETE**

从根节点开始，查询要删除的目标数据所在，若子节点未在缓存中，则从磁盘中加载。

4. **UPDATE**

删除原来的行，并插入新的行。

### 查询模块


### 并发 & 事务模块